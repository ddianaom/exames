<!DOCTYPE html>
<html>
    <head>
	<link rel="stylesheet" href="exams.css">
    </head>
<body>
    <h2>Meus Exames</h2>
    <div id="products"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.3.1/web3.min.js"></script>
    <script>
        // Substitua isso pelo endereço do contrato na sua blockchain
        const contractAddress = "0xef97Bb5b2A71E84a1b23154fDa07Ce65Db83ce48";
        // ABI do contrato (Interface de Aplicativo Binário)
        const contractAbi = [
		{
      "anonymous": false,
      "inputs": [
        {
          "indexed": false,
          "internalType": "uint256",
          "name": "id",
          "type": "uint256"
        },
        {
          "indexed": false,
          "internalType": "address",
          "name": "grantedTo",
          "type": "address"
        }
      ],
      "name": "AccessGranted",
      "type": "event"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": false,
          "internalType": "uint256",
          "name": "id",
          "type": "uint256"
        },
        {
          "indexed": false,
          "internalType": "address payable",
          "name": "owner",
          "type": "address"
        },
        {
          "indexed": false,
          "internalType": "string",
          "name": "ipfsHash",
          "type": "string"
        }
      ],
      "name": "BloodTestCreated",
      "type": "event"
    },
    {
      "inputs": [],
      "name": "bloodTestCount",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function",
      "constant": true
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "name": "bloodTests",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "id",
          "type": "uint256"
        },
        {
          "internalType": "address payable",
          "name": "owner",
          "type": "address"
        },
        {
          "internalType": "string",
          "name": "ipfsHash",
          "type": "string"
        }
      ],
      "stateMutability": "view",
      "type": "function",
      "constant": true
    },
    {
      "inputs": [
        {
          "internalType": "string",
          "name": "_ipfsHash",
          "type": "string"
        }
      ],
      "name": "createBloodTest",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "_id",
          "type": "uint256"
        },
        {
          "internalType": "address",
          "name": "_grantedTo",
          "type": "address"
        }
      ],
      "name": "grantAccess",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "_id",
          "type": "uint256"
        }
      ],
      "name": "getSharedWith",
      "outputs": [
        {
          "internalType": "address[]",
          "name": "",
          "type": "address[]"
        }
      ],
      "stateMutability": "view",
      "type": "function",
      "constant": true
    }
]; // Coloque aqui a ABI do contrato
        let web3;
        let contract;
        
        async function init() {
            if (window.ethereum) {
                try {
                    web3 = new Web3(window.ethereum);
                    await window.ethereum.enable();
                    contract = new web3.eth.Contract(contractAbi, contractAddress);
                    displayProducts();
                } catch (error) {
                    console.error("Usuário recusou o acesso ao Ethereum wallet");
                }
            } else {
                alert('Instale MetaMask!');
            }
        }

        async function buyProduct(id, price) {
            const accounts = await web3.eth.getAccounts();
            await contract.methods.purchaseProduct(id).send({ from: accounts[0], value: price });
            alert('Produto comprado com sucesso!');
            location.reload(); // Recarrega a página para atualizar o estado do produto
        }

        async function displayProducts() {
            const bloodTestCount = await contract.methods.bloodTestCount().call();
            const productsDiv = document.getElementById('products');
            const accounts = await web3.eth.getAccounts();

            for (let i = 1; i <= bloodTestCount; i++) {
                const product = await contract.methods.bloodTests(i).call();
                const productDiv = document.createElement('div');

                let ipfsHashInfo = '';
                if (product.owner === accounts[0]) {
                    ipfsHashInfo = `<p>IPFS Hash: <a href="https://ipfs.io/ipfs/${product.ipfsHash}" target="_blank">${product.ipfsHash}</a></p>`;
                } else {
					continue;
				}

                productDiv.innerHTML = `
                    <h3>Exame ${i}</h3>
                    <p>Dono: ${product.owner}</p>
                    ${ipfsHashInfo}
                    <button id="share-button-${i}" onclick="shareExam(${i})">Compartilhar exame</button>
                    <div id="share-div-${i}" class="hidden">
                        <label for="address-input-${i}">Endereço a ser compartilhado:</label>
                        <input type="text" id="address-input-${i}">
                        <button id="share-confirm-button-${i}">Compartilhar</button>
                        <button id="share-cancel-button-${i}">Cancelar</button>
                    </div>
                `;

                productsDiv.appendChild(productDiv);
            }
        }

		async function shareExam(id) {
            const shareDiv = document.getElementById(`share-div-${id}`);
            const shareButton = document.getElementById(`share-button-${id}`);
            const addressInput = document.getElementById(`address-input-${id}`);
            const shareConfirmButton = document.getElementById(`share-confirm-button-${id}`);
            const shareCancelButton = document.getElementById(`share-cancel-button-${id}`);

            shareButton.disabled = true;
            shareDiv.classList.remove('hidden');

            shareConfirmButton.onclick = async () => {
                const address = addressInput.value;
                if (web3.utils.isAddress(address)) {
                    await contract.methods.grantAccess(id, address).send({ from: (await web3.eth.getAccounts())[0] });
                    alert('Exame compartilhado com sucesso!');
                    shareDiv.classList.add('hidden');
                    shareButton.disabled = false;
                } else {
                    alert('Endereço inválido!');
                }
            };

            shareCancelButton.onclick = () => {
                shareDiv.classList.add('hidden');
                shareButton.disabled = false;
            };
        }

        window.onload = init;
    </script>
</body>
</html>
