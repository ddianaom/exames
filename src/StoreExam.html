<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload do Exame</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="exams.css">
    <style>
        .container-custom {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0px 4px 20px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .custom-button {
            background-color: #921541;
            color: white;
            border: none;
        }

        .custom-button:hover {
            background-color: #7a1d38;
            color: white;
        }

        .file-upload-box {
            border: 2px dashed #ddd;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .file-upload-box input[type="file"] {
            display: none;
        }

        .file-upload-box label {
            display: block;
            cursor: pointer;
            color: #921541;
            font-weight: bold;
        }
    </style>
</head>

<body class="d-flex justify-content-center align-items-center vh-100">
    <div class="container text-center">
        <h2 class="mb-4">Upload do seu Exame</h2>
        <div class="container-custom">
            <div class="file-upload-box">
                <label for="fileUpload">Clique aqui para enviar o exame</label>
                <input type="file" id="fileUpload">
            </div>
            <div class="d-flex justify-content-center">
                <button onclick="uploadFile()" class="btn custom-button mx-2">Upload para IPFS</button>
                <button onclick="createProduct()" id="registerBtn" class="btn custom-button mx-2" disabled>Registrar Exame</button>
            </div>
            <p id="uploadStatus"></p>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.3.1/web3.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script>
        const contractAddress = "0xC99c3561c5c6F8a52A8802ac1a241f2F38CF4d3f";
        const contractAbi = [
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "id",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "address",
                        "name": "grantedTo",
                        "type": "address"
                    }
                ],
                "name": "AccessGranted",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "id",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "address",
                        "name": "revokedFrom",
                        "type": "address"
                    }
                ],
                "name": "AccessRevoked",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "id",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "address payable",
                        "name": "owner",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "string",
                        "name": "ipfsHash",
                        "type": "string"
                    }
                ],
                "name": "BloodTestCreated",
                "type": "event"
            },
            {
                "inputs": [],
                "name": "bloodTestCount",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "name": "bloodTests",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "id",
                        "type": "uint256"
                    },
                    {
                        "internalType": "address payable",
                        "name": "owner",
                        "type": "address"
                    },
                    {
                        "internalType": "string",
                        "name": "ipfsHash",
                        "type": "string"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "string",
                        "name": "_ipfsHash",
                        "type": "string"
                    }
                ],
                "name": "createBloodTest",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "_id",
                        "type": "uint256"
                    },
                    {
                        "internalType": "address",
                        "name": "_grantedTo",
                        "type": "address"
                    }
                ],
                "name": "grantAccess",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "_id",
                        "type": "uint256"
                    },
                    {
                        "internalType": "address",
                        "name": "_revokedFrom",
                        "type": "address"
                    }
                ],
                "name": "revokeAccess",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "_id",
                        "type": "uint256"
                    }
                ],
                "name": "getSharedWith",
                "outputs": [
                    {
                        "internalType": "address[]",
                        "name": "",
                        "type": "address[]"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            }
        ];

        let web3;
        let contract;
        let ipfsHash;

        async function init() {
            if (window.ethereum) {
                try {
                    web3 = new Web3(window.ethereum);
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    contract = new web3.eth.Contract(contractAbi, contractAddress);
                } catch (error) {
                    console.error("Usuário recusou o acesso à Ethereum wallet");
                }
            } else {
                alert('Instale MetaMask!');
            }
        }

        async function uploadFile() {
            console.log('começando');
            web3.eth.getBalance('0x7c2FB10AE20Abcf8b4c5a7355987f82D4ff1338d').then(console.log);

            const fileUpload = document.getElementById('fileUpload');
            const statusEl = document.getElementById('uploadStatus');
            const file = fileUpload.files[0];

            const formData = new FormData();
            formData.append("file", file);

            const API_KEY = "0243807789b005c5f083";
            const API_SECRET = "91611b7129e55d34898486cd34a6cb8afd4dbe3f645e94a9dc7d8b1ab0a5f1ca";

            const url = `https://api.pinata.cloud/pinning/pinFileToIPFS`;

            try {
                const response = await axios.post(url, formData, {
                    maxContentLength: "Infinity",
                    headers: {
                        "Content-Type": `multipart/form-data; boundary=${formData._boundary}`,
                        'pinata_api_key': API_KEY,
                        'pinata_secret_api_key': API_SECRET
                    }
                });

                console.log(response);
                ipfsHash = response.data.IpfsHash;
                statusEl.innerText = 'Arquivo enviado! IPFS Hash: ' + ipfsHash;
                document.getElementById('registerBtn').disabled = false;
            } catch (error) {
                console.error('Erro no upload para IPFS', error);
                statusEl.innerText = 'Erro no upload. Tente novamente.';
            }
        }

        async function createProduct() {
            const accounts = await web3.eth.getAccounts();
            try {
                await contract.methods.createBloodTest(ipfsHash).send({ from: accounts[0] });
                alert('Exame registrado com sucesso!');
            } catch (error) {
                console.error('Erro ao registrar o exame', error);
                alert('Erro ao registrar o exame. Verifique o console para mais detalhes.');
            }
        }

        window.onload = init;
    </script>
</body>

</html>
